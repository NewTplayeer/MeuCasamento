<!DOCTYPE html>
<html lang="pt-pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirmar Presença - Bruno Freitas & Maria Fernanda</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gold: '#a8905b',
                        dark: '#2d2d2d',
                    },
                    fontFamily: {
                        serif: ['"Cormorant Garamond"', 'serif'],
                        sans: ['"Montserrat"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #fafafa; }
        .scale-in { animation: scaleIn 0.3s ease-out; }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .tracking-widest-extra { letter-spacing: 0.2em; }
    </style>
</head>

<body class="text-dark selection:bg-gold selection:text-white min-h-screen flex flex-col font-sans">

    <!-- HEADER -->
    <header class="py-16 px-4 text-center bg-white border-b border-gray-100 shadow-sm">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-4xl md:text-6xl font-serif mb-4 text-dark">Bruno Freitas & Maria Fernanda</h1>
            <div class="w-24 h-px bg-gold mx-auto mb-6"></div>
            <p class="text-gray-400 uppercase tracking-widest-extra text-[10px] md:text-xs">Confirmação de Presença</p>
        </div>
    </header>

    <div id="status-banner" class="hidden max-w-2xl mx-auto mt-6 p-4 rounded-md text-sm text-center font-sans shadow-md border animate-in fade-in duration-300"></div>

    <!-- VISÃO CLIENTE (FORMULÁRIO DE RSVP) -->
    <main id="client-view" class="flex-grow max-w-2xl mx-auto w-full px-6 py-12 md:py-20">
        <div class="bg-white p-8 md:p-12 rounded-sm shadow-xl border border-gray-100">
            <div class="text-center mb-10">
                <i data-lucide="mail-open" class="w-10 h-10 mx-auto text-gold mb-4 stroke-[1.5]"></i>
                <h2 class="text-3xl font-serif text-dark mb-2">Esperamos por si!</h2>
                <p class="text-xs text-gray-500 uppercase tracking-widest leading-relaxed">Por favor, confirme a sua presença até<br>21 de Fevereiro de 2026.</p>
            </div>

            <form id="rsvp-form" class="space-y-6">
                <!-- Nome Completo -->
                <div class="space-y-2">
                    <label class="block text-[10px] uppercase tracking-widest-extra text-gray-400 font-bold">Nome Completo</label>
                    <input type="text" id="form-nome" placeholder="Como devemos colocar na lista?" class="w-full border-b border-gray-200 focus:border-dark outline-none py-3 text-lg bg-transparent transition-colors" required>
                </div>

                <!-- Presença -->
                <div class="space-y-2 pt-4">
                    <label class="block text-[10px] uppercase tracking-widest-extra text-gray-400 font-bold">Poderá comparecer?</label>
                    <div class="flex gap-4">
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="presenca" value="sim" class="peer sr-only" checked onchange="toggleCompanions(true)">
                            <div class="text-center border border-gray-200 p-4 rounded-sm peer-checked:border-dark peer-checked:bg-dark peer-checked:text-white transition-all">
                                <span class="text-xs uppercase tracking-widest">Sim, irei!</span>
                            </div>
                        </label>
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="presenca" value="nao" class="peer sr-only" onchange="toggleCompanions(false)">
                            <div class="text-center border border-gray-200 p-4 rounded-sm peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-500 transition-all">
                                <span class="text-xs uppercase tracking-widest">Não poderei</span>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Acompanhantes (Oculto se não for comparecer) -->
                <div id="companions-section" class="space-y-2 pt-4 transition-all duration-300">
                    <label class="block text-[10px] uppercase tracking-widest-extra text-gray-400 font-bold">Número de Acompanhantes</label>
                    <select id="form-acompanhantes" class="w-full border-b border-gray-200 focus:border-dark outline-none py-3 text-lg bg-transparent transition-colors cursor-pointer">
                        <option value="0">Vou sozinho(a)</option>
                        <option value="1">1 Acompanhante</option>
                        <option value="2">2 Acompanhantes</option>
                        <option value="3">3 Acompanhantes</option>
                        <option value="4">4+ Acompanhantes</option>
                    </select>
                </div>

                <!-- Mensagem / Restrição Alimentar -->
                <div class="space-y-2 pt-4">
                    <label class="block text-[10px] uppercase tracking-widest-extra text-gray-400 font-bold">Mensagem ou Restrição Alimentar (Opcional)</label>
                    <textarea id="form-mensagem" rows="3" placeholder="Deixe uma mensagem aos noivos ou avise-nos sobre alergias..." class="w-full border-b border-gray-200 focus:border-dark outline-none py-3 text-sm bg-transparent transition-colors resize-none"></textarea>
                </div>

                <button type="submit" id="btn-submit" class="w-full py-5 bg-dark text-white rounded-sm text-xs uppercase tracking-widest-extra hover:bg-black transition-all mt-8 active:scale-[0.98]">
                    Enviar Confirmação
                </button>
            </form>
        </div>
        
        <div class="text-center mt-8">
            <a href="index.html" class="text-[10px] uppercase tracking-widest text-gray-400 hover:text-dark transition-colors border-b border-transparent hover:border-dark pb-1">Voltar ao Convite</a>
        </div>
    </main>

    <!-- VISÃO ADMIN (PAINEL DE GESTÃO) -->
    <main id="admin-view" class="flex-grow max-w-5xl mx-auto w-full p-6 md:p-10 hidden">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 border-b border-gray-200 pb-6 gap-4">
            <div>
                <h2 class="font-serif text-4xl text-dark mb-2">Lista de Convidados</h2>
                <p class="text-xs uppercase tracking-widest text-gray-500">Gestão de Presenças</p>
            </div>
            <div class="flex gap-4">
                <div class="text-center bg-white px-6 py-3 border border-gray-100 shadow-sm rounded-sm">
                    <p class="text-[10px] uppercase tracking-widest text-gray-400">Total Confirmados</p>
                    <p id="total-guests" class="text-2xl font-serif text-dark">0</p>
                </div>
                <button onclick="setView('client')" class="text-[10px] uppercase tracking-widest bg-gray-100 text-dark px-6 py-3 rounded-sm hover:bg-gray-200 transition-all border border-gray-200 h-fit my-auto">Sair</button>
            </div>
        </div>
        
        <div class="bg-white rounded-sm shadow-lg border border-gray-100 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-50 text-gray-500 border-b border-gray-100">
                        <tr class="uppercase text-[10px] tracking-widest">
                            <th class="py-4 px-6 font-medium">Nome do Convidado</th>
                            <th class="py-4 px-6 font-medium text-center">Status</th>
                            <th class="py-4 px-6 font-medium text-center">Acompanhantes</th>
                            <th class="py-4 px-6 font-medium">Mensagem</th>
                            <th class="py-4 px-6 font-medium text-right">Ação</th>
                        </tr>
                    </thead>
                    <tbody id="rsvp-list" class="divide-y divide-gray-50">
                        <!-- Linhas geradas via JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- RODAPÉ E LOGIN -->
    <footer class="py-12 bg-white border-t border-gray-100 text-center">
        <p class="text-gray-400 text-[9px] tracking-[0.3em] uppercase mb-4">Maria Fernanda & Bruno • 2026</p>
        <button onclick="openLoginModal()" class="text-gray-300 hover:text-dark flex items-center gap-2 mx-auto text-[10px] uppercase tracking-widest transition-colors">
            <i data-lucide="lock" class="w-3 h-3"></i> Gestão
        </button>
    </footer>

    <!-- MODAL DE LOGIN ADMIN -->
    <div id="modal-login" class="fixed inset-0 z-50 hidden items-center justify-center p-6 bg-dark/40 backdrop-blur-sm">
        <div class="bg-white p-10 shadow-2xl max-w-md w-full scale-in relative border-t-4 border-gold">
            <button onclick="closeModal('modal-login')" class="absolute top-6 right-6 text-gray-400 hover:text-dark"><i data-lucide="x" class="w-5 h-5"></i></button>
            <h2 class="text-3xl font-serif mb-2 text-dark text-center">Acesso Reservado</h2>
            <p class="text-gray-500 text-xs mb-8 text-center uppercase tracking-widest">Insira a senha do casal</p>
            
            <div class="space-y-6">
                <input type="password" id="login-pass-input" placeholder="Palavra-passe" 
                    class="w-full border-b border-gray-200 focus:border-dark outline-none py-3 text-center tracking-[0.3em] transition-all"
                    onkeypress="if(event.key === 'Enter') handleAdminAuth()">
                
                <button onclick="handleAdminAuth()" class="w-full py-4 bg-dark text-white text-[10px] uppercase tracking-widest hover:bg-black transition-all">
                    Entrar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE SUCESSO -->
    <div id="modal-success" class="fixed inset-0 z-50 hidden items-center justify-center p-6 bg-dark/40 backdrop-blur-sm">
        <div class="bg-white p-12 shadow-2xl max-w-md w-full scale-in text-center border border-gray-100">
            <i data-lucide="check-circle" class="w-16 h-16 mx-auto text-gold mb-6 stroke-[1]"></i>
            <h3 class="text-3xl font-serif text-dark mb-4">Obrigado!</h3>
            <p id="success-message" class="text-gray-500 text-sm mb-8 leading-relaxed"></p>
            <button onclick="closeModal('modal-success'); window.location.href='index.html'" class="w-full py-4 bg-dark text-white text-[10px] uppercase tracking-widest hover:bg-black transition-all">
                Voltar ao Convite
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURAÇÃO FIREBASE DO BRUNO (Reutilizada)
        const firebaseConfig = {
            apiKey: "AIzaSyCVjoXpO5PwW3-7B8KBs4jzKQcVWVCzi_s",
            authDomain: "casamento-fb87b.firebaseapp.com",
            projectId: "casamento-fb87b",
            storageBucket: "casamento-fb87b.firebasestorage.app",
            messagingSenderId: "727131908134",
            appId: "1:727131908134:web:e1df1695894c2220171ee7",
            measurementId: "G-QFL6YHZF0X"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Lógica de Caminhos
        const isCanvas = typeof __app_id !== 'undefined';
        const currentAppId = isCanvas ? __app_id : 'casamento_mb';
        const rsvpPath = isCanvas 
            ? ['artifacts', currentAppId, 'public', 'data', 'rsvps'] 
            : ['casamento_mb', 'lista', 'presencas'];

        const ADMIN_PASSWORD = "NewT.001"; // Mesma senha da lista de presentes
        let user = null;
        let rsvps = [];

        // UI HELPERS
        lucide.createIcons();

        window.toggleCompanions = (show) => {
            const section = document.getElementById('companions-section');
            if (show) {
                section.classList.remove('opacity-50', 'pointer-events-none', 'hidden');
            } else {
                section.classList.add('opacity-50', 'pointer-events-none', 'hidden');
                document.getElementById('form-acompanhantes').value = "0";
            }
        };

        window.openLoginModal = () => {
            if (sessionStorage.getItem('admin_authed') === 'true') { setView('admin'); } 
            else { document.getElementById('modal-login').classList.remove('hidden'); document.getElementById('modal-login').classList.add('flex'); }
        };

        window.closeModal = (id) => { 
            document.getElementById(id).classList.add('hidden'); 
            document.getElementById(id).classList.remove('flex'); 
        };

        window.setView = (v) => {
            document.getElementById('client-view').classList.toggle('hidden', v !== 'client');
            document.getElementById('admin-view').classList.toggle('hidden', v !== 'admin');
            window.scrollTo(0,0);
        };

        window.handleAdminAuth = () => {
            const input = document.getElementById('login-pass-input').value;
            if (input === ADMIN_PASSWORD) {
                sessionStorage.setItem('admin_authed', 'true');
                closeModal('modal-login');
                setView('admin');
            } else {
                alert("Senha incorreta!");
                document.getElementById('login-pass-input').value = "";
            }
        };

        // --- SUBMETER RSVP ---
        document.getElementById('rsvp-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            btn.disabled = true;
            btn.innerText = "A Enviar...";

            const nome = document.getElementById('form-nome').value.trim();
            const vaiComparecer = document.querySelector('input[name="presenca"]:checked').value === "sim";
            const acompanhantes = vaiComparecer ? parseInt(document.getElementById('form-acompanhantes').value) : 0;
            const mensagem = document.getElementById('form-mensagem').value.trim();

            try {
                await addDoc(collection(db, ...rsvpPath), {
                    nome, vaiComparecer, acompanhantes, mensagem, timestamp: new Date().toISOString()
                });
                
                document.getElementById('rsvp-form').reset();
                toggleCompanions(true); // Reset radio
                
                // Mensagem personalizada de sucesso
                const msgEl = document.getElementById('success-message');
                if(vaiComparecer) {
                    msgEl.innerHTML = `Que bom que estará connosco, <b>${nome}</b>!<br>A sua presença foi confirmada com sucesso.`;
                } else {
                    msgEl.innerHTML = `Agradecemos por nos avisar, <b>${nome}</b>.<br>Sentiremos a sua falta!`;
                }
                
                document.getElementById('modal-success').classList.remove('hidden');
                document.getElementById('modal-success').classList.add('flex');
            } catch (err) {
                console.error(err);
                alert("Erro ao enviar. Tente novamente.");
            } finally {
                btn.disabled = false;
                btn.innerText = "Enviar Confirmação";
            }
        };

        // --- ADMIN: LER DADOS ---
        function initAdminData() {
            onSnapshot(collection(db, ...rsvpPath), snap => {
                rsvps = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderAdminList();
            });
        }

        function renderAdminList() {
            const list = document.getElementById('rsvp-list');
            if(!list) return;

            // Calcular total de pessoas (convidados confirmados + acompanhantes)
            let totalPessoas = 0;
            
            const sorted = [...rsvps].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            list.innerHTML = sorted.map(r => {
                if (r.vaiComparecer) totalPessoas += (1 + r.acompanhantes);
                
                const statusBadge = r.vaiComparecer 
                    ? `<span class="bg-green-100 text-green-700 py-1 px-3 rounded-full text-[9px] uppercase tracking-widest">Confirmado</span>`
                    : `<span class="bg-red-100 text-red-700 py-1 px-3 rounded-full text-[9px] uppercase tracking-widest">Não Vai</span>`;
                
                return `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="py-4 px-6 text-dark">${r.nome}</td>
                    <td class="py-4 px-6 text-center">${statusBadge}</td>
                    <td class="py-4 px-6 text-center text-gray-500">${r.vaiComparecer ? r.acompanhantes : '-'}</td>
                    <td class="py-4 px-6 text-gray-500 italic max-w-xs truncate" title="${r.mensagem}">${r.mensagem || '-'}</td>
                    <td class="py-4 px-6 text-right">
                        <button onclick="handleDeleteRsvp('${r.id}')" class="text-gray-300 hover:text-red-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                </tr>`;
            }).join('');

            document.getElementById('total-guests').innerText = totalPessoas;
            lucide.createIcons();
        }

        window.handleDeleteRsvp = async (id) => {
            if(confirm("Tem certeza que deseja apagar esta confirmação?")) {
                await deleteDoc(doc(db, ...rsvpPath, id));
            }
        };

        // Init App
        async function startApp() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token).catch(async () => await signInAnonymously(auth));
                } else { await signInAnonymously(auth); }
            } catch (err) { console.error(err); }
            
            onAuthStateChanged(auth, u => { 
                if(u) { user = u; initAdminData(); } 
            });
        }
        startApp();
    </script>
</body>
</html>